<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA -->
  <meta name="theme-color" content="#007bff">
  <link rel="manifest" href="manifest.json">

  <title>Pr√©sences aux r√©unions</title>

  <style>
    :root{
      --bg:#f4f6f8; --card:#fff; --ink:#111; --muted:#6c757d; --line:#e6e6e6;
      --primary:#007bff; --secondary:#6c757d; --danger:#d62828;
      --shadow: 0 2px 10px rgba(0,0,0,.08); --radius:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:14px; max-width:920px; margin-inline:auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--ink);
    }
    h1{ margin:8px 0 14px; text-align:center; font-size:22px; }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:14px;
    }

    label{ display:block; margin-top:10px; font-weight:800; font-size:14px; }
    input, select{
      width:100%;
      padding:12px;
      margin-top:8px;
      font-size:16px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .row > *{ flex:1; min-width:220px; }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:900;
      padding:14px;
      border-radius:14px;
      width:100%;
    }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-secondary{ background:var(--secondary); color:#fff; }

    /* Accord√©ons */
    details.block{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:10px;
      overflow:hidden;
    }
    summary.sum{
      list-style:none;
      cursor:pointer;
      padding:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    summary.sum::-webkit-details-marker{ display:none; }

    .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .title{ font-weight:900; text-transform:capitalize; }
    .meta{ font-size:13px; color:var(--muted); font-weight:800; }

    .actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-shrink:0;
    }

    /* Boutons ic√¥nes (plus l√©gers) */
    .icon-btn{
      width:40px;
      height:40px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f2f3f5;
      cursor:pointer;
    }
    .icon-btn:active{ transform:scale(.95); }
    .icon-btn span{ font-size:18px; }

    .share-icon{
      width:18px;
      height:18px;
      fill:#111;
    }

    /* Fl√®ches (plus discr√®tes) */
    .chev{
      font-weight:900;
      font-size:14px;
      padding:6px 10px;
      border-radius:999px;
      background:transparent;
      border:1px solid rgba(0,0,0,.10);
      color:#111;
    }
    details.block:not([open]) .chev::before { content:"‚ñº"; }
    details.block[open] .chev::before { content:"‚ñ≤"; }

    /* Listes d‚Äôentr√©es */
    .list{
      padding:10px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:8px;
      border-top:1px solid var(--line);
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background:#fff;
    }
    .item-date{ font-weight:900; }
    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:#f7f8fa;
      border:1px solid var(--line);
      font-weight:900;
      min-width:60px;
      text-align:center;
    }
    .del{
      border:none;
      background:none;
      color:var(--danger);
      font-size:18px;
      cursor:pointer;
      font-weight:900;
    }

    .hint{ color:var(--muted); font-size:13px; margin-top:8px; font-weight:700; }

    @media (max-width:480px){
      body{ padding:10px; }
      h1{ font-size:20px; }
      .row > *{ min-width:100%; }
      .icon-btn{ width:36px; height:36px; }
      .icon-btn span{ font-size:17px; }
      .share-icon{ width:16px; height:16px; }
    }
  </style>
</head>

<body>

<h1>Pr√©sences aux r√©unions</h1>

<div class="card">
  <label>Date de la r√©union</label>
  <input type="date" id="date">

  <label>Nombre de pr√©sents</label>
  <input type="number" id="count" min="0" inputmode="numeric" placeholder="Ex: 84">

  <div class="row">
    <button class="btn btn-primary" id="addBtn">Ajouter</button>
  </div>

  <div class="row">
    <div>
      <label>P√©riode √† exporter (PDF)</label>
      <select id="exportPeriod"></select>
      <div class="hint">Tu peux aussi exporter/partager un mois via les ic√¥nes dans la liste.</div>
    </div>
  </div>

  <div class="row">
    <button class="btn btn-secondary" id="exportBtn">Exporter PDF</button>
  </div>
</div>

<div class="card" id="container"></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

<script>
  let data = JSON.parse(localStorage.getItem("presences")) || [];

  const $date = document.getElementById("date");
  const $count = document.getElementById("count");
  const $container = document.getElementById("container");
  const $exportPeriod = document.getElementById("exportPeriod");

  function formatDateFR(dateISO){
    const [y,m,d] = dateISO.split("-");
    return `${d}/${m}/${y}`;
  }
  function yearKey(dateISO){ return dateISO.slice(0,4); }
  function monthKey(dateISO){ return dateISO.slice(0,7); } // YYYY-MM

  function monthLabel(yyyyMM){
    return new Date(yyyyMM + "-01").toLocaleDateString("fr-FR", { month:"long", year:"numeric" });
  }

  function save(){
    localStorage.setItem("presences", JSON.stringify(data));
    render();
  }

  function groupYearMonth(entries){
    const out = {}; // {YYYY: {YYYY-MM: [entries]}}
    entries.forEach(e=>{
      const y = yearKey(e.date);
      const m = monthKey(e.date);
      if(!out[y]) out[y] = {};
      if(!out[y][m]) out[y][m] = [];
      out[y][m].push(e);
    });
    return out;
  }

  function refreshExportPeriod(){
    const years = [...new Set(data.map(e=>yearKey(e.date)))].sort();
    const monthsAll = [...new Set(data.map(e=>monthKey(e.date)))].sort();

    const current = $exportPeriod.value || "ALL";

    $exportPeriod.innerHTML = "";

    // Tout
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "Tout (toutes ann√©es)";
    $exportPeriod.appendChild(optAll);

    // Ann√©es
    years.forEach(y=>{
      const o = document.createElement("option");
      o.value = `Y:${y}`;
      o.textContent = `Ann√©e ${y}`;
      $exportPeriod.appendChild(o);

      // Mois de cette ann√©e
      monthsAll
        .filter(m => m.startsWith(y + "-"))
        .forEach(m=>{
          const mo = document.createElement("option");
          mo.value = `M:${m}`;
          mo.textContent = `‚Äî ${monthLabel(m)}`;
          $exportPeriod.appendChild(mo);
        });
    });

    // Restore selection if possible
    const validValues = new Set(Array.from($exportPeriod.options).map(o => o.value));
    $exportPeriod.value = validValues.has(current) ? current : "ALL";
  }

  async function buildPdfBlob(monthKeysToExport){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const keys = [...monthKeysToExport].sort();

    keys.forEach((k, idx)=>{
      if(idx > 0) doc.addPage();
      doc.setFontSize(14);
      doc.text(`Pr√©sences ‚Äì ${monthLabel(k)}`, 14, 16);

      const entries = data.filter(e => monthKey(e.date) === k);
      doc.autoTable({
        startY: 24,
        head: [["Date", "Pr√©sents"]],
        body: entries.map(e => [formatDateFR(e.date), String(e.count)])
      });
    });

    return doc.output("blob");
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function getMonthsForPeriod(periodValue){
    const monthsAll = [...new Set(data.map(e=>monthKey(e.date)))].sort();

    if(periodValue === "ALL") return monthsAll;

    if(periodValue.startsWith("Y:")){
      const y = periodValue.slice(2);
      return monthsAll.filter(m => m.startsWith(y + "-"));
    }

    if(periodValue.startsWith("M:")){
      const m = periodValue.slice(2);
      return monthsAll.includes(m) ? [m] : [];
    }

    return [];
  }

  async function exportSelected(){
    if(!data.length){ alert("Aucune donn√©e √† exporter."); return; }

    const period = $exportPeriod.value || "ALL";
    const months = getMonthsForPeriod(period);
    if(!months.length){ alert("Aucune donn√©e pour ce choix."); return; }

    const blob = await buildPdfBlob(months);

    const today = new Date().toISOString().slice(0,10);
    let name = `presences_${today}.pdf`;

    if(period === "ALL") name = `presences_tout_${today}.pdf`;
    else if(period.startsWith("Y:")) name = `presences_${period.slice(2)}_${today}.pdf`;
    else if(period.startsWith("M:")) name = `presences_${period.slice(2)}_${today}.pdf`;

    downloadBlob(blob, name);
  }

  async function exportMonth(yyyyMM){
    const blob = await buildPdfBlob([yyyyMM]);
    const today = new Date().toISOString().slice(0,10);
    downloadBlob(blob, `presences_${yyyyMM}_${today}.pdf`);
  }

  async function shareMonth(yyyyMM){
    const blob = await buildPdfBlob([yyyyMM]);
    const today = new Date().toISOString().slice(0,10);
    const file = new File([blob], `presences_${yyyyMM}_${today}.pdf`, { type:"application/pdf" });

    if(navigator.share && navigator.canShare && navigator.canShare({ files:[file] })){
      try{
        await navigator.share({
          title: "Pr√©sences aux r√©unions",
          text: `Pr√©sences ‚Äì ${monthLabel(yyyyMM)}`,
          files: [file]
        });
      }catch{}
    }else{
      downloadBlob(blob, `presences_${yyyyMM}_${today}.pdf`);
      alert("Partage direct non support√© ici. PDF t√©l√©charg√© : tu peux l‚Äôenvoyer via WhatsApp/Mail.");
    }
  }

  function openAndScrollTo(y, m){
    const yearEl = document.querySelector(`details.block[data-year="${y}"]`);
    const monthEl = document.querySelector(`details.block[data-month="${m}"]`);

    if(yearEl) yearEl.open = true;
    if(monthEl) monthEl.open = true;

    const target = monthEl || yearEl;
    if(target){
      target.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }

  function render(){
    refreshExportPeriod();

    $container.innerHTML = "";

    const grouped = groupYearMonth(data);
    const years = Object.keys(grouped).sort();

    if(!years.length){
      $container.innerHTML = `<div class="hint">Aucune donn√©e pour le moment.</div>`;
      return;
    }

    const currentYear = new Date().toISOString().slice(0,4);

    years.forEach(y=>{
      const months = Object.keys(grouped[y]).sort();

      const yearMeetings = months.reduce((s,m)=>s + grouped[y][m].length, 0);
      const yearTotal = months.reduce((s,m)=>s + grouped[y][m].reduce((a,e)=>a+e.count,0), 0);
      const yearAvg = yearMeetings ? (yearTotal / yearMeetings).toFixed(1) : "0.0";

      const yearDetails = document.createElement("details");
      yearDetails.className = "block";
      yearDetails.dataset.year = y;
      if(y === currentYear) yearDetails.open = true;

      const monthsHtml = months.map(m=>{
        const entries = grouped[y][m];
        const total = entries.reduce((s,e)=>s+e.count,0);
        const avg = (total/entries.length).toFixed(1);

        const rows = entries.map(e=>{
          const idx = data.indexOf(e);
          return `
            <div class="item">
              <div class="item-date">${formatDateFR(e.date)}</div>
              <div class="right">
                <span class="pill">${e.count}</span>
                <button class="del" onclick="deleteEntry(${idx})" aria-label="Supprimer">‚úñ</button>
              </div>
            </div>
          `;
        }).join("");

        return `
          <details class="block" data-month="${m}" style="margin:10px 14px 14px;">
            <summary class="sum">
              <div class="left">
                <div class="title">${monthLabel(m)}</div>
                <div class="meta">${entries.length} r√©unions ‚Ä¢ total ${total} ‚Ä¢ moy. ${avg}</div>
              </div>
              <div class="actions">
                <div class="icon-btn" onclick="event.preventDefault(); exportMonth('${m}')" title="Exporter PDF">
                  <span>üì§</span>
                </div>
                <div class="icon-btn" onclick="event.preventDefault(); shareMonth('${m}')" title="Partager">
                  <svg class="share-icon" viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.6" y1="10.9" x2="15.4" y2="6.1" stroke="#111" stroke-width="2"></line>
                    <line x1="8.6" y1="13.1" x2="15.4" y2="17.9" stroke="#111" stroke-width="2"></line>
                  </svg>
                </div>
                <span class="chev" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="list">
              ${rows || `<div class="hint">Aucune r√©union.</div>`}
            </div>
          </details>
        `;
      }).join("");

      yearDetails.innerHTML = `
        <summary class="sum">
          <div class="left">
            <div class="title">${y}</div>
            <div class="meta">${yearMeetings} r√©unions ‚Ä¢ total ${yearTotal} ‚Ä¢ moy. ${yearAvg}</div>
          </div>
          <div class="actions">
            <span class="chev" aria-hidden="true"></span>
          </div>
        </summary>
        <div style="padding-bottom: 6px;">
          ${monthsHtml}
        </div>
      `;

      $container.appendChild(yearDetails);
    });
  }

  // Expose deleteEntry for inline onclick
  window.deleteEntry = deleteEntry;

  function deleteEntry(index){
    data.splice(index, 1);
    save();
  }

  function addEntry(){
    if(!$date.value || $count.value === ""){
      alert("Champs manquants");
      return;
    }

    const d = $date.value;
    const y = yearKey(d);
    const m = monthKey(d);

    data.push({ date: d, count: Number($count.value) });
    data.sort((a,b)=>a.date.localeCompare(b.date));

    $count.value = "";
    localStorage.setItem("presences", JSON.stringify(data));
    render();

    // ‚úÖ auto-open + scroll
    setTimeout(() => openAndScrollTo(y, m), 50);

    $count.focus();
  }

  // events
  document.getElementById("addBtn").addEventListener("click", addEntry);
  document.getElementById("exportBtn").addEventListener("click", exportSelected);
  $count.addEventListener("keydown", (e)=>{ if(e.key === "Enter") addEntry(); });

  // default date
  $date.value = new Date().toISOString().slice(0,10);

  render();
</script>

<!-- PWA service worker -->
<script>
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
